openapi: 3.0.3
info:
  title: KubeDesk Helper API
  description: |
    HTTP API for the KubeDesk Helper service that provides unsandboxed operations
    for the KubeDesk macOS application (distributed via Mac App Store).

    The helper runs as a local HTTP server on port 47823 and enables:
    - kubectl command execution
    - Raw bash command execution (pipes, redirects, complex shell features)
    - Exec-based authentication (AWS EKS, GCP GKE, Azure AKS, etc.)
    - Port-forwarding sessions
    - Exec into pods
    - kubectl proxy

    The helper loads the user's shell environment to ensure access to tools like
    kubectl, gke-gcloud-auth-plugin, aws CLI, and other exec-based auth plugins.

    ## Cluster Isolation

    All endpoints support cluster hash validation to prevent cross-cluster contamination.
    The cluster hash is a SHA256-based identifier computed from kubeconfig content and
    context name. Sessions are tied to specific clusters, ensuring operations intended
    for one cluster never execute on another.

    - **Automatic**: Helper computes cluster hash if not provided (backward compatible)
    - **Validation**: All session operations validate cluster hash
    - **Cleanup**: Use `/sessions/cleanup` endpoint when switching clusters
    - **Zero tolerance**: Impossible to access sessions from wrong cluster

  version: 2.0.0
  contact:
    name: KubeDesk
    url: https://github.com/kubedeskpro/kubedesk-helper

servers:
  - url: http://localhost:47823
    description: Local helper service

paths:
  /health:
    get:
      summary: Health check
      description: Returns the helper version and status
      operationId: getHealth
      responses:
        '200':
          description: Helper is healthy
          content:
            application/json:
              schema:
                type: object
                required:
                  - version
                  - status
                properties:
                  version:
                    type: string
                    example: "2.0.0"
                  status:
                    type: string
                    example: "ok"

  /kubectl:
    post:
      summary: Execute kubectl command
      description: Executes a kubectl command with the provided arguments
      operationId: executeKubectl
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - args
              properties:
                args:
                  type: array
                  items:
                    type: string
                  example: ["get", "pods", "-n", "default"]
                kubeconfig:
                  type: string
                  description: Optional path to kubeconfig file
                  example: "/Users/user/.kube/config"
                context:
                  type: string
                  description: Optional kubectl context to use
                  example: "my-cluster"
                clusterHash:
                  type: string
                  description: |
                    Optional cluster hash for validation (SHA256 of kubeconfig:context, first 16 chars).
                    If not provided, helper computes it automatically.
                  example: "a22d510f831cc112"
      responses:
        '200':
          description: Command executed successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - stdout
                  - stderr
                  - exit_code
                properties:
                  stdout:
                    type: string
                  stderr:
                    type: string
                  exit_code:
                    type: integer
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Command execution failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /exec-auth:
    post:
      summary: Execute authentication command
      description: |
        Executes an exec-based authentication command from kubeconfig.
        Used for cloud provider authentication (AWS EKS, GCP GKE, Azure AKS, etc.)
      operationId: executeExecAuth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - command
              properties:
                command:
                  type: string
                  description: Command to execute
                  example: "aws"
                args:
                  type: array
                  items:
                    type: string
                  example: ["eks", "get-token", "--cluster-name", "my-cluster"]
                env:
                  type: object
                  additionalProperties:
                    type: string
                  description: Environment variables
                  example:
                    AWS_PROFILE: "default"
      responses:
        '200':
          description: Authentication command executed successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - stdout
                  - stderr
                  - exit_code
                properties:
                  stdout:
                    type: string
                    description: Standard output (typically JSON credential response)
                  stderr:
                    type: string
                  exit_code:
                    type: integer
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Command execution failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /shell/start:
    post:
      summary: Start shell command session
      description: |
        Starts a bash command session via /bin/bash -c.
        Supports full shell features including pipes, redirects, environment variables,
        wildcards, command substitution, and complex pipelines.

        Unlike the simple kubectl endpoint, this supports long-running commands without
        arbitrary timeouts (e.g., watch, tail -f). Use /shell/output/{sessionId} to read
        output and /shell/stop/{sessionId} to terminate the command.

        Examples:
        - Pipes: kubectl get pods | grep nginx
        - Redirects: kubectl get pods > /tmp/pods.txt
        - Multiple commands: kubectl get pods && kubectl get services
        - Environment variables: export NS=default && kubectl get pods -n $NS
        - Complex pipelines: kubectl get pods -o json | jq '.items[].metadata.name' | sort
        - Long-running: watch kubectl get pods
      operationId: startShell
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - command
              properties:
                command:
                  type: string
                  description: Full shell command string to execute
                  example: "kubectl get pods | grep nginx"
                kubeconfig:
                  type: string
                  description: |
                    Kubeconfig file path or content. Recommended to always provide this along with context.
                    Will be written to temp file and set as KUBECONFIG env var.
                  example: "apiVersion: v1\nkind: Config\n..."
                context:
                  type: string
                  description: |
                    Kubectl context name. Recommended to always provide this along with kubeconfig.
                    The helper will automatically inject --context flag into all kubectl commands in the shell.
                    This ensures cluster isolation even for chained commands like "kubectl get pods && kubectl get svc".
                  example: "my-cluster"
                clusterHash:
                  type: string
                  description: |
                    Optional cluster hash for validation (SHA256 of kubeconfig:context, first 16 chars).
                    If not provided, helper computes it automatically. Session is tied to this cluster.

                    IMPORTANT: If only clusterHash is provided (without kubeconfig/context), the helper
                    will attempt to look it up from its in-memory registry. However, this registry is
                    cleared on helper restart, so it's recommended to always provide kubeconfig and context
                    for reliability.
                  example: "a22d510f831cc112"
      responses:
        '200':
          description: Shell session started successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - sessionId
                  - status
                properties:
                  sessionId:
                    type: string
                    example: "shell-abc123"
                  status:
                    type: string
                    example: "running"
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Failed to start command
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /shell/output/{sessionId}:
    get:
      summary: Read output from shell session
      description: Reads all accumulated output from a shell session since it started.
      operationId: shellOutput
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
          example: "shell-abc123"
        - name: clusterHash
          in: query
          required: false
          schema:
            type: string
          description: Optional cluster hash for validation. If provided, validates session belongs to this cluster.
          example: "a22d510f831cc112"
      responses:
        '200':
          description: Output retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  output:
                    type: string
                    description: Accumulated output from the session (stdout + stderr combined)
                  timestamp:
                    type: string
                    format: date-time
                  status:
                    type: string
                    enum: [running, stopped, failed]
                  exitCode:
                    type: integer
                    format: int32
                    description: Exit code (only present when command has completed)
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /shell/stop/{sessionId}:
    delete:
      summary: Stop shell session
      description: Stops an active shell session by killing the process
      operationId: stopShell
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
          example: "shell-abc123"
        - name: clusterHash
          in: query
          required: false
          schema:
            type: string
          description: Optional cluster hash for validation. If provided, validates session belongs to this cluster.
          example: "a22d510f831cc112"
      responses:
        '200':
          description: Session stopped successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Session stopped"
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /shell/list:
    get:
      summary: List active shell sessions
      description: Returns a list of all active shell sessions
      operationId: listShell
      responses:
        '200':
          description: List of active sessions
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessions:
                    type: array
                    items:
                      type: object
                      properties:
                        sessionId:
                          type: string
                        command:
                          type: string
                        status:
                          type: string
                        startedAt:
                          type: string
                          format: date-time
                        exitCode:
                          type: integer
                          format: int32
                          description: Exit code (only present when command has completed)

  /port-forward/start:
    post:
      summary: Start port-forward session
      description: Starts a kubectl port-forward session
      operationId: startPortForward
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - namespace
                - podName
                - localPort
                - remotePort
              properties:
                namespace:
                  type: string
                  example: "default"
                podName:
                  type: string
                  example: "my-pod-12345"
                localPort:
                  type: integer
                  example: 8080
                remotePort:
                  type: integer
                  example: 80
                kubeconfig:
                  type: string
                  description: |
                    Kubeconfig file path or content. Recommended to always provide this along with context
                    to ensure correct cluster targeting, especially after helper restarts.
                context:
                  type: string
                  description: |
                    Kubectl context name. Recommended to always provide this along with kubeconfig
                    to ensure correct cluster targeting, especially after helper restarts.
                clusterHash:
                  type: string
                  description: |
                    Optional cluster hash for validation (SHA256 of kubeconfig:context, first 16 chars).
                    If not provided, helper computes it automatically. Session is tied to this cluster.

                    IMPORTANT: If only clusterHash is provided (without kubeconfig/context), the helper
                    will attempt to look it up from its in-memory registry. However, this registry is
                    cleared on helper restart, so it's recommended to always provide kubeconfig and context
                    for reliability.
                  example: "a22d510f831cc112"
      responses:
        '200':
          description: Port-forward session started
          content:
            application/json:
              schema:
                type: object
                required:
                  - sessionId
                properties:
                  sessionId:
                    type: string
                    example: "pf-abc123"
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Failed to start port-forward
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /port-forward/stop/{sessionId}:
    delete:
      summary: Stop port-forward session
      description: Stops an active port-forward session
      operationId: stopPortForward
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
          example: "pf-abc123"
        - name: clusterHash
          in: query
          required: false
          schema:
            type: string
          description: Optional cluster hash for validation. If provided, validates session belongs to this cluster.
          example: "a22d510f831cc112"
      responses:
        '200':
          description: Session stopped successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Session stopped"
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /port-forward/list:
    get:
      summary: List active port-forward sessions
      description: Returns a list of all active port-forward sessions
      operationId: listPortForward
      responses:
        '200':
          description: List of active sessions
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessions:
                    type: array
                    items:
                      type: object
                      properties:
                        sessionId:
                          type: string
                        namespace:
                          type: string
                        podName:
                          type: string
                        localPort:
                          type: integer
                        remotePort:
                          type: integer

  /exec:
    post:
      summary: Execute command in pod (synchronous)
      description: |
        Executes a command in a pod and waits for it to complete.
        This is a SYNCHRONOUS operation - the HTTP request stays open until the command finishes.

        **This is the RECOMMENDED way to exec into pods** because:
        - No session management needed
        - No risk of premature cleanup
        - Automatic temp file cleanup
        - Simple request/response pattern
        - Built-in timeout protection

        **Use this for:**
        - Running commands and getting output (ls, cat, ps, etc.)
        - Health checks and diagnostics
        - One-shot operations

        **App behavior:**
        ```swift
        let response = try await helperAPI.post("/exec", body: request)
        if response.exitCode == 0 {
            showOutput(response.output)
        } else {
            showError(response.output, exitCode: response.exitCode)
        }
        ```

        The connection will stay open until:
        - Command completes (success or failure)
        - Timeout is reached (default: 300 seconds)
        - Client cancels the request

      operationId: executeExec
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - namespace
                - podName
                - command
              properties:
                namespace:
                  type: string
                  example: "default"
                podName:
                  type: string
                  example: "my-pod-12345"
                container:
                  type: string
                  description: Optional container name (defaults to first container)
                  example: "app"
                command:
                  type: array
                  items:
                    type: string
                  description: Command and arguments to execute
                  example: ["ls", "-la", "/app"]
                kubeconfig:
                  type: string
                  description: |
                    Kubeconfig content (YAML). Recommended to always provide this along with context.
                    Will be written to a temporary file and cleaned up automatically after command completes.
                  example: "apiVersion: v1\nkind: Config\n..."
                context:
                  type: string
                  description: |
                    Kubectl context name. Recommended to always provide this along with kubeconfig.
                  example: "my-cluster"
                clusterHash:
                  type: string
                  description: |
                    Optional cluster hash for validation (SHA256 of kubeconfig:context, first 16 chars).
                    If not provided, helper computes it automatically.
                  example: "a22d510f831cc112"
                timeout:
                  type: integer
                  description: Maximum seconds to wait for command to complete (default: 300)
                  example: 60
                  default: 300
      responses:
        '200':
          description: Command completed (check exitCode to determine success/failure)
          content:
            application/json:
              schema:
                type: object
                required:
                  - output
                  - exitCode
                  - duration
                properties:
                  output:
                    type: string
                    description: Combined stdout and stderr output
                    example: "total 48\ndrwxr-xr-x  12 root root 4096 Nov 27 10:00 .\n..."
                  exitCode:
                    type: integer
                    format: int32
                    description: Exit code (0 = success, non-zero = failure, -1 = error)
                    example: 0
                  duration:
                    type: number
                    format: float
                    description: Execution time in seconds
                    example: 1.234
                  error:
                    type: string
                    description: Error message (only present if exitCode is -1)
                    example: "kubectl not found in PATH"
        '400':
          description: Invalid request (missing fields or cluster hash mismatch)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Command execution failed
          content:
            application/json:
              schema:
                type: object
                required:
                  - output
                  - exitCode
                  - duration
                properties:
                  output:
                    type: string
                  exitCode:
                    type: integer
                    format: int32
                  duration:
                    type: number
                    format: float
                  error:
                    type: string
        '504':
          description: Command timed out
          content:
            application/json:
              schema:
                type: object
                required:
                  - output
                  - exitCode
                  - duration
                  - error
                properties:
                  output:
                    type: string
                    description: Partial output before timeout
                  exitCode:
                    type: integer
                    format: int32
                    example: -1
                  duration:
                    type: number
                    format: float
                  error:
                    type: string
                    example: "Command timed out after 300 seconds"

  /exec/start:
    post:
      summary: Start exec session into pod (DEPRECATED - use /exec instead)
      description: |
        **DEPRECATED:** This session-based API is deprecated in favor of the synchronous /exec endpoint.

        The session-based API is complex and error-prone:
        - Requires polling /exec/output
        - Risk of premature cleanup
        - Temp file race conditions
        - Complex app code

        **Use /exec instead** for a simpler, safer API.

        This endpoint is kept for backward compatibility only.
      deprecated: true
      operationId: startExec
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - namespace
                - podName
                - command
              properties:
                namespace:
                  type: string
                  example: "default"
                podName:
                  type: string
                  example: "my-pod-12345"
                container:
                  type: string
                  description: Optional container name (defaults to first container)
                  example: "app"
                command:
                  type: array
                  items:
                    type: string
                  example: ["/bin/sh"]
                kubeconfig:
                  type: string
                  description: |
                    Kubeconfig file path or content. Recommended to always provide this along with context
                    to ensure correct cluster targeting, especially after helper restarts.
                context:
                  type: string
                  description: |
                    Kubectl context name. Recommended to always provide this along with kubeconfig
                    to ensure correct cluster targeting, especially after helper restarts.
                clusterHash:
                  type: string
                  description: |
                    Optional cluster hash for validation (SHA256 of kubeconfig:context, first 16 chars).
                    If not provided, helper computes it automatically. Session is tied to this cluster.

                    IMPORTANT: If only clusterHash is provided (without kubeconfig/context), the helper
                    will attempt to look it up from its in-memory registry. However, this registry is
                    cleared on helper restart, so it's recommended to always provide kubeconfig and context
                    for reliability.
                  example: "a22d510f831cc112"
      responses:
        '200':
          description: Exec session started
          content:
            application/json:
              schema:
                type: object
                required:
                  - sessionId
                properties:
                  sessionId:
                    type: string
                    example: "exec-xyz789"
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Failed to start exec session
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /exec/input/{sessionId}:
    post:
      summary: Send input to exec session
      description: Sends input data to an active exec session
      operationId: execInput
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
          example: "exec-xyz789"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - input
              properties:
                input:
                  type: string
                  description: Input data to send to the session
                  example: "ls -la\n"
                clusterHash:
                  type: string
                  description: Optional cluster hash for validation. If provided, validates session belongs to this cluster.
                  example: "a22d510f831cc112"
      responses:
        '200':
          description: Input sent successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Input sent"
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /exec/output/{sessionId}:
    get:
      summary: Read output from exec session
      description: Reads output from an active exec session
      operationId: execOutput
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
          example: "exec-xyz789"
        - name: clusterHash
          in: query
          required: false
          schema:
            type: string
          description: Optional cluster hash for validation. If provided, validates session belongs to this cluster.
          example: "a22d510f831cc112"
      responses:
        '200':
          description: Output retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  output:
                    type: string
                    description: Output from the session
                  timestamp:
                    type: string
                    description: Timestamp when session started
                    example: "2024-01-15T10:30:00Z"
                  status:
                    type: string
                    description: Session status (running, stopped, failed)
                    enum: [running, stopped, failed]
                    example: "stopped"
                  exitCode:
                    type: integer
                    format: int32
                    nullable: true
                    description: Exit code of the command (null if still running, 0 for success, non-zero for failure)
                    example: 0
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /exec/stop/{sessionId}:
    delete:
      summary: Stop exec session
      description: Stops an active exec session
      operationId: stopExec
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
          example: "exec-xyz789"
        - name: clusterHash
          in: query
          required: false
          schema:
            type: string
          description: Optional cluster hash for validation. If provided, validates session belongs to this cluster.
          example: "a22d510f831cc112"
      responses:
        '200':
          description: Session stopped successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Session stopped"
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /exec/list:
    get:
      summary: List active exec sessions
      description: Returns a list of all active exec sessions
      operationId: listExec
      responses:
        '200':
          description: List of active sessions
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessions:
                    type: array
                    items:
                      type: object
                      properties:
                        sessionId:
                          type: string
                        namespace:
                          type: string
                        podName:
                          type: string
                        container:
                          type: string

  /proxy/start:
    post:
      summary: Start kubectl proxy
      description: Starts a kubectl proxy server
      operationId: startProxy
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                port:
                  type: integer
                  description: Port for proxy server (default 8001)
                  example: 8001
                kubeconfig:
                  type: string
                  description: Optional kubeconfig content
                context:
                  type: string
                  description: Optional kubectl context to use
                clusterHash:
                  type: string
                  description: |
                    Optional cluster hash for validation (SHA256 of kubeconfig:context, first 16 chars).
                    If not provided, helper computes it automatically. Session is tied to this cluster.
                  example: "a22d510f831cc112"
      responses:
        '200':
          description: Proxy started successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - sessionId
                  - port
                properties:
                  sessionId:
                    type: string
                    example: "proxy-def456"
                  port:
                    type: integer
                    example: 8001
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Failed to start proxy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /proxy/stop/{sessionId}:
    delete:
      summary: Stop kubectl proxy
      description: Stops an active kubectl proxy session
      operationId: stopProxy
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
          example: "proxy-def456"
        - name: clusterHash
          in: query
          required: false
          schema:
            type: string
          description: Optional cluster hash for validation. If provided, validates session belongs to this cluster.
          example: "a22d510f831cc112"
      responses:
        '200':
          description: Proxy stopped successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Proxy stopped"
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /proxy/list:
    get:
      summary: List active proxy sessions
      description: Returns a list of all active kubectl proxy sessions
      operationId: listProxy
      responses:
        '200':
          description: List of active sessions
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessions:
                    type: array
                    items:
                      type: object
                      properties:
                        sessionId:
                          type: string
                        port:
                          type: integer

  /sessions/cleanup:
    post:
      summary: Clean up sessions for a cluster
      description: |
        Removes all sessions associated with a specific cluster hash.
        This should be called when switching clusters to ensure no stale sessions remain.

        **Critical for cluster isolation**: Always call this endpoint when switching clusters
        to prevent accidentally using sessions from the wrong cluster.
      operationId: cleanupSessions
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - clusterHash
              properties:
                clusterHash:
                  type: string
                  description: Cluster hash to clean up (SHA256 of kubeconfig:context, first 16 chars)
                  example: "a22d510f831cc112"
      responses:
        '200':
          description: Sessions cleaned up successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - sessionsRemoved
                  - clusterHash
                properties:
                  sessionsRemoved:
                    type: integer
                    description: Number of sessions removed
                    example: 3
                  clusterHash:
                    type: string
                    description: Cluster hash that was cleaned up
                    example: "a22d510f831cc112"
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  schemas:
    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          example: "Invalid request"


